worker_processes 1;

events {
    worker_connections 1024;
}

http {
    server {
        listen 80;
        server_name _;

        location /health {
            return 200;
        }

        location /api/v1/auth {
            auth_request off;
            proxy_set_header Host $host;
            proxy_pass http://auth_backend:8082;
        }

        location /api/v1/profile {
            auth_request off;
            proxy_set_header Host $host;
            proxy_pass http://auth_backend:8082;
        }

        location /api/v1/ {
            auth_request /auth_send_request;
            error_page 401 /401.json;
            error_page 403 /403.json;

           location ~ /image {
                client_max_body_size 5M;
                proxy_set_header Host $host;
                proxy_pass http://image_backend:8081;
           }

           location ~ /track {
                client_max_body_size 20M;
                proxy_set_header Host $host;
                proxy_pass http://track_backend:8080;
           }
        }

        location /auth_send_request {
            internal;
            proxy_method          GET;
            proxy_set_header      Host $host;
            proxy_set_header      Authorization $http_authorization;
            proxy_pass_header     Authorization;
            proxy_pass            http://auth_backend:8082/api/v1/auth/introspect;
            proxy_set_header      Content-Length "";
            proxy_ignore_headers  Cache-Control Expires Set-Cookie;
        }

        location /401.json {
            return 401 '{"error": "unauthorized"}';
        }

        location /403.json {
            return 403 '{"error": "forbidden"}';
        }
    }
}